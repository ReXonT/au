<?php

$act = $_REQUEST['act'];

/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 * Режим OPTIONS - в котором ВРМ создаёт в схеме блок управления  *
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

if($act == 'options') {
    $responce = [
        'title' => 'ВРМ Заголовок',      // Это заголовок блока, который будет виден на схеме
        'data' => [                     // Массив подключаемых хранилищ
            'data1' => [                // ключ data1 станет именем поля, которое покажется в настройках блока
                'title' => 'Хранилище с настройками', // Подпись блока с настроками
            ],                          // тут можно насоздавать ещё полей для хранилищь, но нам сейчас нужно только одно
        ],
        'vars' => [                     // переменные, которые можно будет настроить в блоке
            'search' => [
                'title' => 'Новый игрок id',   // заголовок поля
                'desc' => '',    // описание поля, можно пару строк
                'default' => 0          // значение по умолчанию
            ],
            'friendsList' => [
                'title' => 'Список друзей',   // заголовок поля
                'desc' => '',    // описание поля, можно пару строк
                'default' => 0          // значение по умолчанию
            ]
        ],
        'out' => [                      // Это блоки выходов, мы задаём им номера и подписи (будут видны на схеме)
            1 => [                      // Номер 0 означает красный выход блока ВРМ, зарезервированный для случаев сбоя
                'title' => 'Найдено',    // название выхода 1
            ]
        ]
    ];

/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
 * Режим RUN - в котором ВРМ получает, обрабатывает и возвращает  *
 * полученные от схемы данные                                   *
 * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
} elseif($act == 'run') {              // Схема прислала данные, обрабатываем

    $target = $_REQUEST['target'];  // Пользователь, от имени которого выполняется блок
    $ums    = $_REQUEST['ums'];     // Данные об активности пользователя, массив в котором есть
                                    // id - номер элемента (комментария, поста, смотря о чём речь в активности)
                                    // from_id - UID пользователя
                                    // date - дата в формате timestamp
                                    // text - текст комментария, сообщения и т.д.
    $data1  = $_REQUEST['data1'];   // Вот сюда придёт JSON хранилища, ID которого хранится в настройке блока под именем data1
                                    // Можно передавать несколько хранилищ, но не увлекайтесь с объёмом
    $out    = 0;                    // Номер выхода по умолчанию. Если дальнейший код не назначит другой выход - значит что-то не так
	$options = $_REQUEST['options'];
    $newText = $options['search'];
    $friendsList = $options['friendsList'];
    /* Теперь, начинаем работать с тем, что прислала активность */
    $varsToFind = rtrim($data1['text'],',');
    $varsToFind = explode(',', $data1['text']);

    $s = true;
    foreach ($varsToFind as $value) {
    	if($value == $newText)
    		$s = false;
    }
    if($s) $data1['text'] .= $newText.',';

    $i = 0;
    foreach ($friendsList as $value) {
    	foreach ($varsToFind as $v) {
    		if($value == $v)
    		{
    			$foundFriends[$i++] = $value;
    		}
    	}
    }

    $out = 1;

    // Сформировать массив данных на отдачу

    $responce = [
        'out' => $out,         // Обязательно должен быть номер выхода out, отличный от нуля!
        'data' => [
            'data1' => $data1,  // Можно отправить хранилище data1, которое перезапишет текущие данные в хранилище с учётом изменений
        ],
        'value' => [
        	'foundFriends' => $foundFriends
        ]
    ];

} elseif($act == '') {
    // Действие не задано, и что же нам сделать? Станцевать вальс, попрыгать, пойти в гости к Кролику?

}

// Отдать JSON, не кодируя кириллические символы в кракозябры
echo json_encode($responce, JSON_UNESCAPED_UNICODE);